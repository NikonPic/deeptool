---

title: RNN VAE

keywords: fastai
sidebar: home_sidebar

summary: "Structure for an Approach maintained a pseudo space realtion "
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs\23_rnn_vae.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># load some test dataset to confirm architecture:</span>
<span class="kn">from</span> <span class="nn">deeptool.parameters</span> <span class="kn">import</span> <span class="n">get_all_args</span>
<span class="kn">from</span> <span class="nn">deeptool.dataloader</span> <span class="kn">import</span> <span class="n">load_test_batch</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">get_all_args</span><span class="p">()</span>
<span class="n">args</span><span class="o">.</span><span class="n">model_type</span> <span class="o">=</span> <span class="s2">&quot;rnnvae&quot;</span>
<span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">load_test_batch</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<span class="n">batch</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([1, 3, 16, 256, 256])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="mod_batch" class="doc_header"><code>mod_batch</code><a href="https://github.com/NikonPic/deeptool/tree/master/deeptool/model/rnnvae.py#L14" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>mod_batch</code>(<strong><code>batch</code></strong>, <strong><code>key</code></strong>=<em><code>'img'</code></em>)</p>
</blockquote>
<p>transform the batch to be compatible with the network by permuting</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">batch</span> <span class="o">=</span> <span class="n">mod_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<span class="n">batch</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([16, 3, 256, 256])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">args</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">enc_part</span> <span class="o">=</span> <span class="n">DownUpConv</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">pic_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">n_fea_in</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_fea_next</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span>
<span class="n">enc_part</span><span class="o">.</span><span class="n">min_size</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>4</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">RNN_VAE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The recurrent autoencoder for compressing 3d data.</span>
<span class="sd">        It compresses in 2d while (hopefully) maintaining the spatial relation between layers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RNN_VAE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

        <span class="c1"># 1. create the convolutional Encoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_part_enc</span> <span class="o">=</span> <span class="n">DownUpConv</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">pic_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pic_size</span><span class="p">,</span> <span class="n">n_fea_in</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">perspectives</span><span class="p">),</span> <span class="n">n_fea_next</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">n_fea_up</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># save important features</span>
        <span class="n">max_fea</span><span class="p">,</span> <span class="n">min_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_part_enc</span><span class="o">.</span><span class="n">max_fea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_part_enc</span><span class="o">.</span><span class="n">min_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_arr</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_fea</span> <span class="o">*</span> <span class="n">min_size</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># 2. Apply FC- Encoder Part</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_part_enc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">max_fea</span><span class="o">*</span><span class="n">min_size</span><span class="o">*</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_fea</span><span class="o">*</span><span class="n">min_size</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">max_fea</span><span class="o">*</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_fea</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">max_fea</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n_z</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># 3. Transition Layer: GRU</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transition</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">n_z</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n_z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># 4. Apply FC-Decoder Part</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_part_dec</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">n_z</span><span class="p">,</span> <span class="n">max_fea</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">max_fea</span><span class="p">,</span> <span class="n">max_fea</span><span class="o">*</span><span class="n">min_size</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">max_fea</span><span class="o">*</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_fea</span><span class="o">*</span><span class="n">min_size</span><span class="o">*</span><span class="n">min_size</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># 5. create the convolutional Decoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_part_dec</span> <span class="o">=</span> <span class="n">DownUpConv</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">pic_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">pic_size</span><span class="p">,</span> <span class="n">n_fea_in</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">perspectives</span><span class="p">),</span> <span class="n">n_fea_next</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">n_fea_down</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">move</span><span class="o">=</span><span class="s1">&#39;up&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">rnn_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        take the matrix of encoded input slices and apply the RNN part</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
        

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculate the forward pass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># move to gpu</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># encode:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_part_enc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">view_arr</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_part_enc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="c1"># apply the GRU transition</span>
        
        
        <span class="k">return</span> <span class="n">x</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">n_gpu</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
<span class="n">rnn_vae</span> <span class="o">=</span> <span class="n">RNN_VAE</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
<span class="n">rnn_vae</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-intense-fg ansi-bold">---------------------------------------------------------------------------</span>
<span class="ansi-red-intense-fg ansi-bold">TypeError</span>                                 Traceback (most recent call last)
<span class="ansi-green-intense-fg ansi-bold">&lt;ipython-input-43-01901b801478&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">      1</span> device = torch.device(&#34;cuda:0&#34; if (
<span class="ansi-green-fg">      2</span>         torch.cuda.is_available() and args.n_gpu &gt; 0) else &#34;cpu&#34;)
<span class="ansi-green-intense-fg ansi-bold">----&gt; 3</span><span class="ansi-yellow-intense-fg ansi-bold"> </span>rnn_vae <span class="ansi-yellow-intense-fg ansi-bold">=</span> RNN_VAE<span class="ansi-yellow-intense-fg ansi-bold">(</span>device<span class="ansi-yellow-intense-fg ansi-bold">,</span> args<span class="ansi-yellow-intense-fg ansi-bold">)</span>
<span class="ansi-green-fg">      4</span> rnn_vae<span class="ansi-yellow-intense-fg ansi-bold">(</span>batch<span class="ansi-yellow-intense-fg ansi-bold">)</span><span class="ansi-yellow-intense-fg ansi-bold">.</span>shape

<span class="ansi-green-intense-fg ansi-bold">&lt;ipython-input-42-11f1c9de15af&gt;</span> in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-intense-fg ansi-bold">(self, device, args)</span>
<span class="ansi-green-fg">     11</span>         <span class="ansi-red-intense-fg ansi-bold"># 1. create the convolutional Encoder</span>
<span class="ansi-green-fg">     12</span>         self.conv_part_enc = DownUpConv(args, pic_size=args.pic_size, n_fea_in=len(
<span class="ansi-green-intense-fg ansi-bold">---&gt; 13</span><span class="ansi-yellow-intense-fg ansi-bold">             args.perspectives), n_fea_next=args.n_fea_up, depth=1).to(self.device)
</span><span class="ansi-green-fg">     14</span> 
<span class="ansi-green-fg">     15</span>         <span class="ansi-red-intense-fg ansi-bold"># save important features</span>

<span class="ansi-green-intense-fg ansi-bold">c:\users\ga46yeg\juliaprojects\deeptool\deeptool\architecture.py</span> in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-intense-fg ansi-bold">(self, args, n_fea_in, n_fea_next, pic_size, depth, move, p_drop)</span>
<span class="ansi-green-fg">    275</span>     <span class="ansi-green-intense-fg ansi-bold">def</span> __init__<span class="ansi-yellow-intense-fg ansi-bold">(</span>self<span class="ansi-yellow-intense-fg ansi-bold">,</span> args<span class="ansi-yellow-intense-fg ansi-bold">,</span> n_fea_in<span class="ansi-yellow-intense-fg ansi-bold">,</span> n_fea_next<span class="ansi-yellow-intense-fg ansi-bold">,</span> pic_size<span class="ansi-yellow-intense-fg ansi-bold">,</span> depth<span class="ansi-yellow-intense-fg ansi-bold">,</span> move<span class="ansi-yellow-intense-fg ansi-bold">=</span><span class="ansi-blue-intense-fg ansi-bold">&#34;down&#34;</span><span class="ansi-yellow-intense-fg ansi-bold">,</span> p_drop<span class="ansi-yellow-intense-fg ansi-bold">=</span><span class="ansi-cyan-intense-fg ansi-bold">0</span><span class="ansi-yellow-intense-fg ansi-bold">)</span><span class="ansi-yellow-intense-fg ansi-bold">:</span>
<span class="ansi-green-fg">    276</span>         <span class="ansi-blue-intense-fg ansi-bold">&#34;&#34;&#34;Setup the conv-network&#34;&#34;&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">--&gt; 277</span><span class="ansi-yellow-intense-fg ansi-bold">         </span>super<span class="ansi-yellow-intense-fg ansi-bold">(</span>DownUpConv<span class="ansi-yellow-intense-fg ansi-bold">,</span> self<span class="ansi-yellow-intense-fg ansi-bold">)</span><span class="ansi-yellow-intense-fg ansi-bold">.</span>__init__<span class="ansi-yellow-intense-fg ansi-bold">(</span><span class="ansi-yellow-intense-fg ansi-bold">)</span>
<span class="ansi-green-fg">    278</span>         <span class="ansi-red-intense-fg ansi-bold"># Convolutions in 2d / 3d</span>
<span class="ansi-green-fg">    279</span>         self<span class="ansi-yellow-intense-fg ansi-bold">.</span>dim <span class="ansi-yellow-intense-fg ansi-bold">=</span> args<span class="ansi-yellow-intense-fg ansi-bold">.</span>dim

<span class="ansi-red-intense-fg ansi-bold">TypeError</span>: super(type, obj): obj must be an instance or subtype of type</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">??</span> DownUpConv
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

